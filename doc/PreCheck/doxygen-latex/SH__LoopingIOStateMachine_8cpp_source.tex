\hypertarget{SH__LoopingIOStateMachine_8cpp}{\section{S\-H\-\_\-\-Looping\-I\-O\-State\-Machine.\-cpp}
\label{SH__LoopingIOStateMachine_8cpp}\index{logic/\-S\-H\-\_\-\-Looping\-I\-O\-State\-Machine.\-cpp@{logic/\-S\-H\-\_\-\-Looping\-I\-O\-State\-Machine.\-cpp}}
}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include "\hyperlink{SH__LoopingIOStateMachine_8h}{SH\_LoopingIOStateMachine.h}"}
00002 \textcolor{preprocessor}{#include "\hyperlink{SH__AdaptDatabaseState_8h}{SH\_AdaptDatabaseState.h}"}
00003 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00010}{}\hyperlink{classSh__LoopingInOutStateMachine_a5de32ba5bb4fd034036a16665f91cdb4}{00010} \hyperlink{classSh__LoopingInOutStateMachine_a5de32ba5bb4fd034036a16665f91cdb4}{Sh\_LoopingInOutStateMachine::Sh\_LoopingInOutStateMachine}
      (QString tableName, QString name, \textcolor{keywordtype}{int} limit, \hyperlink{classQObject}{QObject} *parent) :
00011     \hyperlink{classSH__InOutStateMachine}{SH\_InOutStateMachine}(tableName, name, parent), m\_limit(limit), m\_current(-1)
00012 \{
00013 
00014 \}
00015 
00016 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00023}{}\hyperlink{classSh__LoopingInOutStateMachine_a1b4661f92617e9cdbacc1be354f2a54a}{00023} \textcolor{keywordtype}{int} \hyperlink{classSh__LoopingInOutStateMachine_a1b4661f92617e9cdbacc1be354f2a54a}{Sh\_LoopingInOutStateMachine::current}()\textcolor{keyword}{ const}
00024 \textcolor{keyword}{}\{
00025     \textcolor{keywordflow}{return} \hyperlink{classSh__LoopingInOutStateMachine_a6bcf7bcfe684dbd4d11ed327948e161b}{m\_current};
00026 \}
00027 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00034}{}\hyperlink{classSh__LoopingInOutStateMachine_ac94dde3e948b7b86a575e421cce2b9ba}{00034} \textcolor{keywordtype}{void} \hyperlink{classSh__LoopingInOutStateMachine_ac94dde3e948b7b86a575e421cce2b9ba}{Sh\_LoopingInOutStateMachine::setCurrent}(\textcolor{keywordtype}{int} current)
00035 \{
00036     \hyperlink{classSh__LoopingInOutStateMachine_a6bcf7bcfe684dbd4d11ed327948e161b}{m\_current} = \hyperlink{classSh__LoopingInOutStateMachine_a1b4661f92617e9cdbacc1be354f2a54a}{current};
00037 \}
00038 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00039}{}\hyperlink{classSh__LoopingInOutStateMachine_aa7d8c9cc870607ed9ef75319bff88500}{00039} \textcolor{keywordtype}{void} \hyperlink{classSh__LoopingInOutStateMachine_aa7d8c9cc870607ed9ef75319bff88500}{Sh\_LoopingInOutStateMachine::setPersistentContentValue}
      (QVariant value, QString field)
00040 \{
00041     \hyperlink{classSh__LoopingInOutStateMachine_ad9c0db5b057a6ba340ffcaddce60d6da}{m\_persistentContent}.insert(field, value);
00042 \}
00043 
00050 \textcolor{keywordtype}{int} \hyperlink{classSh__LoopingInOutStateMachine_ac44b7158256f09b878c8958cf3ae3bf8}{Sh\_LoopingInOutStateMachine::limit}()\textcolor{keyword}{ const}
00051 \textcolor{keyword}{}\{
00052     \textcolor{keywordflow}{return} \hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit};
00053 \}
00054 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00061}{}\hyperlink{classSh__LoopingInOutStateMachine_ab5e9ac94cbd9a47a45dcb50e777c398b}{00061} \textcolor{keywordtype}{void} \hyperlink{classSh__LoopingInOutStateMachine_ab5e9ac94cbd9a47a45dcb50e777c398b}{Sh\_LoopingInOutStateMachine::setLimit}(\textcolor{keywordtype}{int} limit)
00062 \{
00063     \hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit} = \hyperlink{classSh__LoopingInOutStateMachine_ac44b7158256f09b878c8958cf3ae3bf8}{limit};
00064     emit \hyperlink{classSh__LoopingInOutStateMachine_a5b65ad7a49294022ff781c71c4702157}{limitChanged}();
00065 \}
00066 
00067 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00072}{}\hyperlink{classSh__LoopingInOutStateMachine_a8788fa9e4c3149bcf7554e2a2b960c51}{00072} \textcolor{keywordtype}{void} \hyperlink{classSh__LoopingInOutStateMachine_a8788fa9e4c3149bcf7554e2a2b960c51}{Sh\_LoopingInOutStateMachine::stopLooping}() \{
00073     \textcolor{keywordflow}{if}(\hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit} = 0) \{
00074         \hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit} = \hyperlink{classSh__LoopingInOutStateMachine_a6bcf7bcfe684dbd4d11ed327948e161b}{m\_current} + 1;
00075     \} \textcolor{keywordflow}{else} \{
00076         \hyperlink{classSh__LoopingInOutStateMachine_a6bcf7bcfe684dbd4d11ed327948e161b}{m\_current} = \hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit} - 1;
00077     \}
00078 \}
00079 
\hypertarget{SH__LoopingIOStateMachine_8cpp_source_l00086}{}\hyperlink{classSh__LoopingInOutStateMachine_acfd8d0711c793b13c759f6c50be6a315}{00086} \textcolor{keywordtype}{void} \hyperlink{classSh__LoopingInOutStateMachine_acfd8d0711c793b13c759f6c50be6a315}{Sh\_LoopingInOutStateMachine::addChildrenNextTransition}
      (QAbstractState *previousState, QAbstractState *nextState)
00087 \{
00088     \hyperlink{classSH__GenericState}{SH\_GenericState}* genPreviousState = qobject\_cast<
      \hyperlink{classSH__GenericState}{SH\_GenericState}*>(previousState);
00089     \hyperlink{classSH__InOutStateMachine}{SH\_InOutStateMachine}* fsmPreviousState = qobject\_cast<
      \hyperlink{classSH__InOutStateMachine}{SH\_InOutStateMachine}*>(previousState);
00090     QFinalState* \textcolor{keyword}{final} = qobject\_cast<QFinalState*>(nextState);
00091     \textcolor{keywordflow}{if}(\textcolor{keyword}{final}) \{
00092         \textcolor{comment}{/*à faire au moment de l'entrée dans l'état previousState*/}
00093         connect(previousState, &QAbstractState::entered, [=]() \{
00094             \hyperlink{classSh__LoopingInOutStateMachine_a6bcf7bcfe684dbd4d11ed327948e161b}{m\_current}++;
00095             \hyperlink{classSh__LoopingInOutStateMachine_a267e7cbcb3d6a137e2a4e1f93fb57e68}{m\_contents}.append(\hyperlink{classSH__InOutStateMachine_a661a1c7bd3b1086b3b5cd60ca957ecbd}{m\_ioContent});
00096             \hyperlink{classSH__InOutStateMachine_a661a1c7bd3b1086b3b5cd60ca957ecbd}{m\_ioContent}.clear();
00097             \hyperlink{classSH__InOutStateMachine_a661a1c7bd3b1086b3b5cd60ca957ecbd}{m\_ioContent} = \hyperlink{classSh__LoopingInOutStateMachine_ad9c0db5b057a6ba340ffcaddce60d6da}{m\_persistentContent};
00098             \textcolor{keywordflow}{if}(\hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit} == 0 || \hyperlink{classSh__LoopingInOutStateMachine_a6bcf7bcfe684dbd4d11ed327948e161b}{m\_current} < \hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit}) \{
00099                 \textcolor{keywordflow}{if}(genPreviousState) \{
00100                     connect(genPreviousState, &QAbstractState::entered, [=]() \{
00101                         genPreviousState->addTransition(genPreviousState, SIGNAL(
      \hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), initialState());
00102                     \});
00103                 \}
00104                 \textcolor{keywordflow}{if}(fsmPreviousState) \{
00105                     connect(fsmPreviousState, &QAbstractState::entered, [=]() \{
00106                         fsmPreviousState->addTransition(fsmPreviousState, SIGNAL(
      \hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), initialState());
00107                     \});
00108                 \}
00109             \} \textcolor{keywordflow}{else} \{
00110                 \hyperlink{classSH__AdaptDatabaseState}{SH\_AdaptDatabaseState}* nextSaveState = \textcolor{keyword}{new} 
      \hyperlink{classSH__AdaptDatabaseState}{SH\_AdaptDatabaseState}(\textcolor{stringliteral}{"enregistrement 0 de la machine "}+
      \hyperlink{classSH__InOutStateMachine_a60ecd7de03d948e2d1e9cbedb5c3e5fa}{toString}());
00111                 \textcolor{keywordflow}{if}(genPreviousState) \{
00112                     genPreviousState->addTransition(genPreviousState, SIGNAL(
      \hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), nextSaveState);
00113                 \}
00114                 \textcolor{keywordflow}{if}(fsmPreviousState) \{
00115                     fsmPreviousState->addTransition(fsmPreviousState, SIGNAL(
      \hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), nextSaveState);
00116                 \}
00117                 \textcolor{keywordflow}{if}(genPreviousState || fsmPreviousState) \{
00118                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 1; i < \hyperlink{classSh__LoopingInOutStateMachine_a320ece6cf74c2667c70059b9421117fb}{m\_limit}; i++) \{
00119                         \hyperlink{classSH__AdaptDatabaseState}{SH\_AdaptDatabaseState}* saveState = nextSaveState;
00120                         nextSaveState = \textcolor{keyword}{new} \hyperlink{classSH__AdaptDatabaseState}{SH\_AdaptDatabaseState}(QString(\textcolor{stringliteral}{"
      enregistrement %1 de la machine %2"}).arg(QString::number(i)).arg(\hyperlink{classSH__InOutStateMachine_a60ecd7de03d948e2d1e9cbedb5c3e5fa}{toString}()));
00121                         saveState->addTransition(saveState, SIGNAL(\hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()),nextSaveState);
00122                         connect(saveState, &QAbstractState::exited, [=]() \{
00123                             connect(nextSaveState, &QAbstractState::entered, [=]() \{
00124                                 \hyperlink{classSH__InOutStateMachine_aa2766b7a7ba39c35a10df7fc0c151b4f}{setContentValue}(nextSaveState->
      \hyperlink{classSH__AdaptDatabaseState_ab010e64da052db416328d3bcb9ca01d4}{insertUpdate}(\hyperlink{classSH__InOutStateMachine_acc0f5d5133af2dcca30939f53ec8837b}{m\_tableName}, \hyperlink{classSh__LoopingInOutStateMachine_a267e7cbcb3d6a137e2a4e1f93fb57e68}{m\_contents}[i]), \textcolor{stringliteral}{"ID"});
00125                             \});
00126                         \});
00127                     \}
00128                     nextSaveState->addTransition(nextSaveState, SIGNAL(\hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()),\textcolor{keyword}{final});
00129                 \}
00130             \}
00131         \});
00132     \} \textcolor{keywordflow}{else} \{
00133         \textcolor{keywordflow}{if}(genPreviousState) \{
00134             genPreviousState->addTransition(genPreviousState, SIGNAL(\hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), nextState);
00135         \}
00136         \textcolor{keywordflow}{if}(fsmPreviousState) \{
00137             fsmPreviousState->addTransition(fsmPreviousState, SIGNAL(\hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), nextState);
00138         \}
00139     \}
00140     \textcolor{keywordflow}{if}(genPreviousState) \{
00141         \textcolor{comment}{/*à faire au moment de l'entrée dans l'état previousState*/}
00142         connect(genPreviousState, &QAbstractState::entered, [=]() \{
00143             connect(\textcolor{keyword}{this}, &\hyperlink{classSH__InOutStateMachine_af5f82970faef3bca48a147863dba2ee1}{SH\_InOutStateMachine::replaceInput}, [=](
      QString field) \{
00144                 \textcolor{comment}{/*après avoir demandé à revenir sur un état précédent, on attend la fin de l'état actuel
       puis on retourne à l'historique de l'état désiré; celui-ci fini, on passe à l'état qui aurait du suivre celui
       pendant lequel on a demandé à revenir sur un état précédent*/}
00145                 QHistoryState* hState = \hyperlink{classSH__InOutStateMachine_a84fb2b2c2105cae9c590c0d15960854a}{historyValue}(field);
00146                 \textcolor{keywordflow}{if}(hState) \{ \textcolor{comment}{/*si l'historique existe (on a déjà quitté l'état voulu)*/}
00147                     hState->parentState()->addTransition(hState->parentState(), SIGNAL(
      \hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), nextState);
00148                     genPreviousState->addTransition(genPreviousState, SIGNAL(
      \hyperlink{classSH__InOutStateMachine_aa9ee51efe0e17dcf5366c8a97b523892}{next}()), hState);
00149                 \}
00150             \});
00151         \});
00152     \}
00153 \}
\end{DoxyCode}
